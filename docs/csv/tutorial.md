[トップへ戻る](../README.md)

# csv サブコマンドについて

j2shirne の csv サブコマンドの使用方法、及びチュートリアル

## CSV サブコマンドの引数

### 位置引数

CSV フォーマットに固有の位置引数です。
|順番|意味|省略時|
|---|---|---|
|1|テンプレートファイル|使用する jinja2 テンプレートファイルを指定します。|省略不可|
|2|入力|入力として読み込む CSV ファイルを指定します。|省略されると sys.stdin から読み込みます。|

### オプション引数

CSV フォーマットに固有のオプション引数です。
この他にも、汎用の共通引数が存在しますので、別途確認してみてください。
|短い形式|長い形式|引数|デフォルト|効果|
|---|---|---|---|---|
|-H|--header||カラムの順番ごとに左から<br>col_00,col_01...|csv ファイルの 1 行目をヘッダとして認識します<br>ヘッダの値は jinja2 へ渡す項目の名前になります|
|-s|--skip-lines|行数||先頭から指定された行数を読み飛ばします<br>ヘッダを使用する場合、読み飛ばし後の 1 行目をヘッダとして認識します|
|-d|--delimiter|区切り文字|,|カラムの区切り文字がカンマ以外の時に指定します|

# チュートリアル - csv ファイル処理の例

csv サブコマンドを使った csv ファイルの変換処理の例を挙げます。このチュートリアルは**jinja2 テンプレートを理解していること**を前提としています。j2shrine によって csv ファイルを jinja2 で処理する部分のみについて解説します。

## 変換の内容

東京メトロ有楽町線の駅を始発の和光市駅から、途中の護国寺駅まで列挙した csv ファイルを用意しました。
このファイルを、「始発駅から順に各駅が所属する自治体毎にグループ化」した yaml のファイルに変換してみます。
始発の和光市駅から護国寺駅までの 12 駅を順番に並べた csv ファイル`yurakucho.csv`を jinja2 テンプレート`area_group.tmpl`を使って整形してみます。

自治体は複数の駅を含み、1 度通過した自治体をもう 1 度通過するケースはないものとします。

### csv ファイル yurakucho.csv

```
number,name,area
Y-1,和光市,埼玉県和光市
Y-2,地下鉄成増,板橋区
Y-3,地下鉄赤塚,練馬区
Y-4,平和台,練馬区
Y-5,氷川台,練馬区
Y-6,小竹向原,練馬区
Y-7,千川,豊島区
Y-8,要町,豊島区
Y-9,池袋,豊島区
Y-11,東池袋,豊島区
Y-12,護国寺,文京区
```

### jinja2 テンプレート area_group.tmpl

グループ化と変換を行う jinja2 テンプレートファイル`area_group.tmpl`です。

```jinja2
{{params.line}}:
  自治体別分類:
{%- for area, stations in rows | groupby('area') %}
    - {{area}}:
{%- for station in stations %}
      - {{station.line}}-{{station.number}}: {{station.name}}
{%- endfor %}
{%- endfor %}
```

### 変換コマンド実行

これらを使って、以下のコマンドを実行します。

```sh
j2shrine csv -H area_group.tmpl yurakucho.csv -o area_group.yml -p line=東京メトロ有楽町線
```

### 変換結果

うまくいけば、変換結果`area_group.yml`が以下の内容で作成されているはずです。
この変換結果はまだ不完全ですが、それは後ほど説明します。

```yml
東京メトロ有楽町線:
  自治体別分類:
    - 埼玉県和光市:
        - Y-1: 和光市
    - 文京区:
        - Y-12: 護国寺
    - 板橋区:
        - Y-2: 地下鉄成増
    - 練馬区:
        - Y-3: 地下鉄赤塚
        - Y-4: 平和台
        - Y-5: 氷川台
        - Y-6: 小竹向原
    - 豊島区:
        - Y-7: 千川
        - Y-8: 要町
        - Y-9: 池袋
        - Y-11: 東池袋
```

基本的な使い方はこれだけです。

### jinja2 へ渡されるパラメータ

コマンドが実行された時、j2shrine は csv ファイルの中身を以下のような dict に変換して、jinja2 へ渡します。
この dict を処理する jinja2 テンプレートを作成することで、csv ファイルを任意の形式に変換することができます。

```python
{
    'headers' : ['number','name','area'],
    'rows' : [
        {
            'number' : 'Y-1',
            'name' : '和光市',
            'area' : '埼玉県和光市'
        },
        # 以下護国寺まで12駅分続く
    ],
    'params' : {
        'line' : '東京メトロ有楽町線'
    }

}
```

### カスタムフィルター

しかし、ここで出力された yaml のファイルはまだ不完全です。
変換結果では埼玉県和光市の下に文京区が入っていて、地下鉄の駅ナンバーが不連続になっています。
これは、jinja2 テンプレート中で使用した groupby フィルタの動作が「要素をソートしてグループ化」しているためです。
csv ファイルは「行の出現順が意味を持っている」ケースがあるので、ソートしたくないこともあります。

この問題に対処するため、j2shirne では`sequential_groupby`フィルタを用意しています。このフィルタは単にソートを行わないまま groupby を行います。
以下のように、テンプレートで sequential_groupby フィルタを使用します。

```jinja2
{{params.line}}:
  自治体別分類:
{%- for area, stations in rows | sequential_groupby('area') %}
    - {{area}}:
{%- for station in stations %}
      - {{station.line}}-{{station.number}}: {{station.name}}
{%- endfor %}
{%- endfor %}
```

すると、ソートを行わなずにグループ化された yaml データが得られます。

```yml
東京メトロ有楽町線:
  自治体別分類:
    - 埼玉県和光市:
        - Y-1: 和光市
    - 板橋区:
        - Y-2: 地下鉄成増
    - 練馬区:
        - Y-3: 地下鉄赤塚
        - Y-4: 平和台
        - Y-5: 氷川台
        - Y-6: 小竹向原
    - 豊島区:
        - Y-7: 千川
        - Y-8: 要町
        - Y-9: 池袋
        - Y-11: 東池袋
    - 文京区:
        - Y-12: 護国寺
```

このように、j2shrine では csv ファイルのような、取り扱うファイルの形式、データの意図に対応したカスタムフィルタも追加していきます。
フィルタの適用で対応しきれないようなケースでは jinja2 テンプレートそのものの機能で対応できます。j2shrine は jinja2 への入力内容を整理すためのプログラムです。

j2shirne による csv ファイルの取扱いに関する説明は以上です。
