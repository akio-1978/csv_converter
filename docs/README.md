# j2shrine
* j2shrineはjinja2をコマンドラインで実行するツールです。
* データを読み込んで、内容を引数としてjinja2を実行します。
* 入力データとしてcsvやExcelを扱えることが特徴です。
  * version0.1.0現在ではcsv、Excel、jsonの3つの形式に対応しています。

このreadmeの中身は随時整理していきます。
## 動作環境
python3.8 以上

## インストール
``` sh
pip install j2shrine-0.1.0-py3-none-any.whl
```

## コマンド使用方法

### 実行例
data.csvにテンプレートtemplate.j2を適用して、formatted.txtを得る例です。
```
j2shrine csv template.j2 data.csv -O formatted.txt
```

### コマンド構文
コマンドの基本的な構文は以下の形になっています。
```
j2shrine [入力フォーマット] [入力フォーマット固有の引数] [オプション]
```
オプションは全入力フォーマットに共通するものと、特定の入力フォーマットに固有のものがあります。

### 入力フォーマット
以下の3種類から指定します。
* csv
* excel
* json

### 共通のオプション 
全入力フォーマットに共通するオプションです。

|短い形式|長い形式|引数|デフォルト|効果|
|---|---|---|---|---|
|-O|--output|ファイル名|sys.stdout|出力先を指定します|
||--input-encoding|文字エンコーディング|utf-8|入力データの文字エンコーディング|
||--output-encoding|文字エンコーディング|utf-8|出力データの文字エンコーディング|
|-p|--parameters|KEY=VALUE形式の文字列 複数指定可||テンプレートに直接引数を与えます<br>この値はテンプレート中で`params.KEY.VALUE`として参照できます|
|-h|--help|||ヘルプを表示します|

### 入力フォーマット毎の操作
各入力フォーマット毎のコマンド使用方法を解説します。

#### jsonフォーマット
jsonフォーマット処理のコマンドを説明します。jsonの読込には`json.load`を使用しています。
#### 基本構文
``` sh
j2shrine json [テンプレート] [jsonファイル] options...
```
##### 位置引数
jsonフォーマットで使用する位置引数です。デフォルト値がないものは指定必須です。
|引数|値|デフォルト|効果|
|---|---|---|---|
|テンプレート|jinja2テンプレートファイル|なし|使用するjinja2のテンプレートファイル|
|入力ファイル|jsonファイル|sys.stdin|テンプレートに渡されるjsonファイル|

##### オプション引数
jsonフォーマットに固有のオプション引数はありません。

##### jsonからjinja2へ渡されるパラメータ
jsonを読み込んだ結果、j2shrineは以下のパラメータを渡してjinja2を起動します。
``` python
{
    'data' : [dict], # json.loadが生成したdict
    'params' : [dict] # 起動時にオプション--parametersで指定された変数が格納されます
}
```


#### CSVフォーマット
csvフォーマット処理のコマンドを説明します。j2shrineではcsvの処理に`csv.reader`を`dialect='excel'`で使用しています。
#### 基本構文
``` sh
j2shrine csv [テンプレート] [csvファイル] options...
```
##### 位置引数
CSVフォーマットで使用する位置引数です。デフォルト値がないものは指定必須です。
|引数|値|デフォルト|効果|
|---|---|---|---|
|テンプレート|jinja2テンプレートファイル|なし|使用するjinja2のテンプレートファイル|
|入力ファイル|csvファイル|sys.stdin|テンプレートに渡されるcsvファイル|


##### オプション引数
CSVフォーマットに固有のオプション引数です。
|短い形式|長い形式|引数|デフォルト|効果|
|---|---|---|---|---|
|-H|--header||カラムの順番ごとに左から<br>col_00,col_01...|csvファイルの1行目をヘッダとして認識します<br>ヘッダの値はjinja2へ渡す項目の名前になります|
|-s|--skip-lines|行数||先頭から指定された行数を読み飛ばします<br>ヘッダを使用する場合、読み飛ばし後の1行目をヘッダとして認識します|
|-d|--delimiter|区切り文字|,|カラムの区切り文字がカンマ以外の時に指定します|

##### ヘッダを使いたくない場合
ヘッダに指定された名前をテンプレート中で使用したくない場合`--skip-lines 1`で読み飛ばせば、デフォルトのcol_00...を使用できます。

##### csvからjinja2へ渡されるパラメータ
csvを読み込んだ結果、j2shrineは以下のパラメータを渡してjinja2を起動します。
``` python
{
    'rows' : [list:str], # csvの各行をdictで格納したlistです
    'headers' : [list:str], # csvの各行のカラム名に使用されたヘッダ名のlistです
    'params' : [dict] # 起動時にオプション--parametersで指定された変数が格納されます
}
```

##### カスタムフィルター
csvを処理するために使用するカスタムフィルターが定義されています。
* sequential_group_by
  * 行を出現順を維持したままグループ化します
    * jinja2のフィルターgroup_byはgroup化の前にソートを行うため、csvを扱う場合には「行の出現順」が失われてしまうため、不向きなことがあります。
  * jinja2のgroup_byの動作 `A A B B A C` -> `A B C`
  * sequential_group_byの動作 `A A B B A C` -> `A B A C`
  
 #### Excelフォーマット
Excelフォーマット処理のコマンドを説明します。j2shrineでは、ワークシート上に存在する2次元の**表1つのみです。**複数シートを扱うことはできます。
j2shrineは内部でopenpyxlを使用しているので、openpyxlが扱えない旧式の.xlsファイルなどは扱えません。

#### 基本構文
``` sh
j2shrine excel [テンプレート] [excelファイル] [読込シート] [読込箇所] [ヘッダ行] options...
```
##### 位置引数
Excelフォーマットで使用する位置引数です。
|引数|値|デフォルト|効果|
|---|---|---|---|
|テンプレート|jinja2テンプレートファイル|なし|使用するjinja2のテンプレートファイル|
|入力ファイル|excelファイル|なし|テンプレートに渡されるexcelファイル<br>excelファイルはsys.stdinからの読込には非対応です|
|読込シート|excelファイルから読み込むシート|なし|読込むシートを以下の形式で指定します<br>`1` 1番目のシートだけを読み込みます<br>`2:3` 2番目と3番目のシートを読み込みます。<br>`3:` 3番目以降の全てのシートを読み込みます|
|読込箇所|シートから読込む箇所|なし|シートから読込む箇所を以下の形式で指定します<br>`A2:C4` セルA2を起点としてセルC4までを1行ずつ読み込みます<br>`A2:C` セルA2を起点として、AからCまでのセルを全行読み込みます|
|ヘッダ行|ヘッダに使用する行|カラム番号 A B C...|シート中にヘッダとして認識したい行がある場合に、行数を指定します<br>カラムの範囲は読込範囲に合わせます|


##### オプション引数
|短い形式|長い形式|引数|デフォルト|効果|
|---|---|---|---|---|
|-F|--fixed|セル位置 A1 B2 など複数指定可||指定した読込箇所に含まれない、固有のセルを直接指定します。<br>取得した値はjinja2に渡された引数`sheet`から`fixed.A1`の形式で参照できます|


##### Excelからjinja2へ渡されるパラメータ
Excelブックを読み込んだ結果、j2shrineは以下のパラメータを渡してjinja2を起動します。
``` python
{
    'sheets' : {
        'name' : [str] # 読み込んだシートの名前です
        'headers' : [list:str], # このシートで使用したヘッダ名です
        'rows' : [list:dict], # シート中の各行をdictで格納したlistです
        'fixed' : [dict] # シート中から固定的に読み込んだセルのdictです
    },
    'params' : [dict] # 起動時にオプション--parametersで指定された変数が格納されます
}
```

##### カスタムフィルター
excelファイルを処理するために使用するカスタムフィルターが定義されています。
* excel_time
  * `datetime.strftime`形式のフォーマット文字列を引数に取ります。
    * デフォルトでは`%Y/%m/%d`が指定されます。
  * excelの日付または時刻の値を内部的にpythonのdatetimeに変換し、strftimeでフォーマットした結果を返します。
* sequential_group_by
  * 行を出現順を維持したままグループ化します。
  * csvの同名のカスタムフィルタと同じものです。

## j2shrineという名前
既に同じ目的のソフトウェアが多数作られていて、思いつく名前は使われており、若干のオリジナリティが必要になりました（とはいえ、csvやexcelを処理するものは見たことがないですが）。
jinjaは日本の「寺」から命名されたそうなので「寺はtemple、神社はshrineだよ」ということでj2shrineです。
