# toj2
このツールはまだ内部向けのものであり、ドキュメントは最小限しか用意されていません。最終的に分割してドキュメントを書く予定です。

- コマンドラインからjinja2を実行し、テンプレートによる行うツールです。
  - 対応するファイル形式が特徴で、現在以下のファイル形式に対応し、jinja2で自由にレンダリングできます。
    - CSVファイル
    - Excelファイル
    - JSON

## 動作環境
python3.12 以上（たぶん）

## インストール

```sh
# PyPIには上げません。 masterブランチから
pip install git+https://github.com/akio-1978/toj2
```

## コマンドの基本構文
toj2をコマンドラインから実行する例を上げます。

### データ種別ごとコマンド実行例
data.csv data.xlsx data.json の各種データを変換するコマンドの例です。

```sh
# csvファイルの場合
toj2 csv csvtemplate.tmpl data.csv -o rendered.txt
# excelファイルの場合
toj2 excel exceltemplate.tmpl data.xlsx 1 A1:D4 -o rendered.txt
# jsonファイルの場合
toj2 json jsontemplate.tmpl data.json -o rendered.txt
```
## コマンド引数
コマンド引数は以下に別れます
- 位置引数
  - 全データ形式に共通する位置引数
  - 固有の位置引数（主にexcel）
- オプション引数
  - 全データ形式に共通する共通オプション
  - データ種別固有のオプション

以下では、全データ形式に共通する位置引数およびオプションについて解説します。
### 共通位置引数
#### データ種別
csv/excel/jsonのいずれかです。
#### jinja2テンプレート
変換に使うjinja2テンプレートです。このテンプレートが配置された場所を起点として、他のテンプレートを`include`できます。
#### 読込みファイル
変換元として読み込むファイルを指定します。省略した場合、`sys.stdin`からの読込みになります。**excelではファイル名は省略不可です。**

### 共通オプション引数
オプションで指定する引数です。
#### 出力ファイル
`-o output_file`

変換結果を出力するファイルを指定します。省略された場合、`sys.stdout`に出力されます。

#### 文字列エンコーディング

`--input-encoding enc`
`--output-encoding enc`

入出力ファイルのエンコーディングを指定します。デフォルトはUTF8です。**excelでは`--input-encoding`は無視されます。

#### テンプレートパラメータ
jinja2テンプレートに任意の値を渡すことができます。値は`=`でキーと値に区切って指定します。指定できる数に制限はありません。

`--pamaeter PARAM1=A PARAM2=B `

この値は、テンプレート中で`param['PARAM1']`のようにして参照できます。

#### 設定ファイル
引数に指定する値が多数に渡る場合は、jsonファイルに設定を記述することができます。
**設定ファイル仕様は追ってドキュメントを公開します。**

## CSVファイル処理
CSVファイルを処理する際の動作及びコマンドオプションについて説明します。
### jinja2への出力形式
toj2はCSVファイルの各行を読み込み、以下の形式にしてjinja2に渡します。
```python
{
    # 読み取った行の値のdictが入ったlist
    'rows': [dict, dict, dict...],
    # 読み取ったカラム名が入ったlist
    'cols': ['name1', 'name2', 'name3', ...],
    # 起動時に渡したパラメータ
    'params' : {'PARAM' : 'VALUE'}
}
```
## CSVファイル処理オプション
CSVファイル処理の際に指定可能なオプションです。
### デリミタ
ファイルがタブ文字などカンマ以外で区切られている場合、任意の文字を指定できます。タブ区切りの

`--delimiter "\t"`

### ヘッダ
1行目をヘッダ名として項目名に使用します。

`--header`

### 行スキップ
先頭から指定の行数を読み飛ばします。ヘッダのあるCSVに対してヘッダを無視する場合`--skip-lins 1`とします。

`--skip-lins 1`

### カラム名指定
jinja2テンプレートが受け取るカラムの名前を指定します。省略された場合、カラム名は左から順に`col00, col01...`と連番で自動生成されます。

`--names a b c`

この場合カラム名は`a, b, c`となり、3カラムを超える場合は`col03, col04`と自動生成されます。

## Excelファイル処理
Excelファイルを処理する際の動作及びコマンドオプションについて説明します。
### jinja2への出力形式
toj2はExcelファイルをシートごとに読み込み、以下の形式にしてjinja2に渡します。
多数のシートを扱うためにCSVより複雑になっています。
```python
{
  # 各シートごとのリスト
  'sheets' : [
    {
      # シート名
      'name': 'sheet_name', 
      # 絶対座標指定セル
      'abs': {'PARAM' : 'VALUE'},
      # シート内容の行と列
      'rows': [[dict,dict, dict...]],
    }
    ...
  ]
  # 起動時に渡したパラメータ
  'params' : {'LABEL' : 'VALUE'}
}
```


## Excelファイル処理オプション
Excelファイルはオプション以外にも固有の位置引数を持ちます。
### **読込みファイル**
必須の位置引数です。**共通ではオプションですが、excelファイルの場合は必須です。**
変換元として読み込むファイルを指定します。excelの場合は`sys.stdin`からの読込みは行えず、**必ずファイルを指定する必要があります。**
### **シート範囲**
必須の位置引数です。
読込むシートを指定します。シートは1度に複数指定可能です。**数値は1オリジンです。**シート番号の後に`:`を付与することで、指定したシート番号に続く全てのシートを取得できます。
```
# 1枚目のシートのB2:E4を取得する
toj2 excel exceltemplate.tmpl data.xlsx 1 B2:E4 -o rendered.txt
# 3枚目のシートのB2:E4を取得する
toj2 excel exceltemplate.tmpl data.xlsx 3 B2:E4 -o rendered.txt
# 1枚目の全てのシートから全てのシートのB2:E4を取得する
toj2 excel exceltemplate.tmpl data.xlsx 1: B2:E4 -o rendered.txt
```
### **セル範囲指定**
必須の位置引数です。
シート内から読みだすセルの範囲を指定します。excelでは読み取ったセルの先頭からjinja2に渡すカラム名の自動生成が始まります。**指定したセル範囲がA2:E4の場合、カラム名`col00`はB列を示します。**

以下のような書き方で、データを持つすべての行を指定することも可能です。（全ての、という範囲はopenpyxlに依存します）
```
# 1枚目のシートのB2からE列の全てのデータを読み取る
toj2 excel exceltemplate.tmpl data.xlsx 1 B2:E -o rendered.txt
```

### カラム名指定
csvと似た機能オプションです。
jinja2テンプレートが受け取るカラムの名前を指定します。省略された場合、カラム名は左から順に`col00, col01...`と連番で自動生成されます。
ただし、excelでは取得したセル範囲から順に`--names`が適用されます。
```
# 1枚目のシートのB2:E4を取得する
toj2 excel exceltemplate.tmpl data.xlsx 1 B2:E4 --names a b c -o rendered.txt
```
この場合、カラム名`a`はB列のカラムに対して適用されます。

### 絶対位置カラム指定

各シート内で指定したセル範囲外にある値を取得してjinja2テンプレートに任意の値を`--absolute`オプションで取得します。値は`LABEL=CELL`の形式です。

```
# セルA1とA2にある値を取得
toj2 excel exceltemplate.tmpl data.xlsx 1 B2:E --absolute LABEL=A1 -o rendered.txt
```
この値は、テンプレート中で`sheet.abs.A1`のようにして参照できます。

## JSON処理
JSONの処理については特にオプションはありません。
### jinja2への出力形式
toj2はjsonを以下の形式にしてjinja2に渡します。
```python
{
    # 受け取ったjson
    'data': {},
    # 起動時に渡したパラメータ
    'params' : {'PARAM' : 'VALUE'}
}

```

JSON処理については現時点では**作れるから作っただけ**というのが正直なところです。JSON、XML、YAMLなどをjinja2で処理してくれるソフトウェアは既にあるので、信頼性の面でそちらをお勧めします。ただしサポートは継続します。